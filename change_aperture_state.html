<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="utf-8">
    <title>Change Aperture State - TEM Architecture</title>
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=Roboto:300,400,500,700" type="text/css"/>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons"/>
<!-- <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.-.min.css"/> -->
<link rel="stylesheet" href="/assets/css/style.css"/>
<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/font-awesome.min.css"> -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script>
  window.MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']]
  }
};
</script>

  </head>
  <body>
    <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
      <!-- <div class="mdl-layout--fixed-header mdl-layout__header--scroll"> -->
  <header class="mdl-layout__header">
    <div class="mdl-layout__header-row">
      <span class="mdl-layout-title">
        <a href="/">TEM Architecture</a>
      </span>
      <div class="mdl-layout-spacer mdl-layout--large-screen-only"></div>
      <nav class="mdl-navigation mdl-layout--large-screen-only">
        
          <a class="mdl-navigation__link" href="/topics.html">Topics</a>
        
      </nav>
    </div>
  </header>
  <div class="mdl-layout__drawer">
    <span class="mdl-layout-title">TEM Architecture</span>
    <nav class="mdl-navigation">
      
        <a class="mdl-navigation__link" href="/topics.html">Topics</a>
        
      
    </nav>
  </div>
<!-- </div> -->

      <main class="mdl-layout__content">
        <div class="mdl-grid page-container">
    <div class="mdl-card mdl-cell--12-col mdl-shadow--4dp">
        <div class="mdl-card__title">
            <h2 class="mdl-card__title--text">
                Change Aperture State
            </h2>
        </div>
        
<div class="mdl-card__supporting-text">
  <h2 id="current-functionality">Current Functionality</h2>

<p>Return to pyTEM <a href="/pytem.html">here</a>.</p>

<p>The Change Aperture State represents a state for moving to an aperture on a grid tape or stick16.</p>

<h3 id="change-aperture-state-logic">Change Aperture State Logic</h3>

<p>Upon entering this state it handles the entry logic for the state and initializes tape_ranges if it is None. It tries to fetch barcode values from TEM_db (if using tape); otherwise, it sets default values.</p>

<p>Next the code performs the following:</p>

<ol>
  <li>
    <p>Initialization and Logging:
 Clears lists related to aperture critical and error events.
 Logs the action of changing the aperture.</p>
  </li>
  <li>
    <p>State Check for Pause:
 Checks if the current montage state is PAUSE. If yes, it schedules the _change_aperture method to run again after 0.2 seconds and exits the current execution.</p>
  </li>
  <li>
    <p>Preparatory Actions:
 Updates beam center results and informs the system that a new montage is starting.</p>
  </li>
  <li>Abort Conditions Check:
 Checks several conditions to decide whether to abort the operation:
    <ul>
      <li>If required media information is missing.</li>
      <li>If environmental conditions are not suitable.</li>
      <li>If there’s a pending request to abort at the end of the montage.</li>
      <li>If there is insufficient disk space.</li>
      <li>If too many errors have accumulated (default is 3).</li>
    </ul>
  </li>
  <li>Handling of Tape and Aperture:
 Retrieves the next task object (TAO) from the montage controller.
 If a valid TAO is found:
    <ul>
      <li>Checks if the destination directory exists or needs to be created.</li>
      <li>Checks for existing data that might require an abort.</li>
      <li>Performs adjustments based on the first Region of Interest (ROI) from tao.</li>
    </ul>
  </li>
  <li>
    <p>Aperture Movement and Correction:
 Manages movement to the correct grid or aperture based on the tape controller status.
 Deals with potential barcode errors and adjusts based on confidence levels in the barcode readings.</p>
  </li>
  <li>
    <p>Lens and Beam Adjustments:
 Adjusts the beam’s brightness and attempts to find a centroid for the aperture if needed.
 Conducts a quality check on the beam’s brightness and might abort if the beam mean value is too low.
 Manages autocentering of the beam if necessary.</p>
  </li>
  <li>
    <p>Brightfield Imaging:
 Handles brightfield imaging conditions and might abort based on the quality of consecutive brightfield images.</p>
  </li>
  <li>
    <p>Lens Correction Montage:
 Decides whether a new lens correction montage is necessary based on time intervals and changes in lens conditions.</p>
  </li>
  <li>Finalizing and Error Handling:
If no ROIs are found in tao, logs the event but continues processing.
If there are still tasks (taos) left in the montage queue, it triggers the start of another attempt.
Sets the montage state to NONE if no tasks are left.</li>
</ol>

<div class="diagram"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0.00 0.00 2047.81 1527.13">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(144 1383.13)">
<title>%3</title>
<g id="clust1" class="cluster">
<title>cluster_Change Aperture State</title>
<path fill="#e5f5fd" stroke="#aeb6be" d="M12,0C12,0 1747.81,0 1747.81,0 1753.81,0 1759.81,-6 1759.81,-12 1759.81,-12 1759.81,-1227.13 1759.81,-1227.13 1759.81,-1233.13 1753.81,-1239.13 1747.81,-1239.13 1747.81,-1239.13 12,-1239.13 12,-1239.13 6,-1239.13 0,-1233.13 0,-1227.13 0,-1227.13 0,-12 0,-12 0,-6 6,0 12,0" />
<text text-anchor="middle" x="77" y="-1225.53" font-family="Sans-Serif" font-size="12.00" fill="#2d3436">Change Aperture State</text>
</g>
<!-- 6481f034840c4ea7a13aa2200cdbb9e3 -->
<g id="node1" class="node">
<title>6481f034840c4ea7a13aa2200cdbb9e3</title>
<image xlink:href="/icons/start-end.png" width="101px" height="101px" preserveAspectRatio="xMinYMin meet" x="0" y="-300.001" />
<text text-anchor="middle" x="50.5" y="-184.6" font-family="Sans-Serif" font-size="13.00" fill="#2d3436">Enter State</text>
</g>
<!-- bd6086867fd742b8a34e3e3c0cc37b78 -->
<g id="node2" class="node">
<title>bd6086867fd742b8a34e3e3c0cc37b78</title>
<image xlink:href="/icons/decision.png" width="101px" height="101px" preserveAspectRatio="xMinYMin meet" x="175.388" y="-292.824" />
<text text-anchor="middle" x="225.89" y="-177.42" font-family="Sans-Serif" font-size="13.00" fill="#2d3436">Initialize tape_ranges</text>
</g>
<!-- 6481f034840c4ea7a13aa2200cdbb9e3&#45;&gt;bd6086867fd742b8a34e3e3c0cc37b78 -->
<g id="edge1" class="edge">
<title>6481f034840c4ea7a13aa2200cdbb9e3-&gt;bd6086867fd742b8a34e3e3c0cc37b78</title>
<path fill="none" stroke="#7b8894" d="M101.23,-247.43C121.23,-246.61 144.36,-245.66 165.23,-244.81" />
<polygon fill="#7b8894" stroke="#7b8894" points="165.42,-248.3 175.27,-244.39 165.14,-241.31 165.42,-248.3" />
</g>
<!-- 09d82d7c91df41558a00225ee61bae8f -->
<g id="node3" class="node">
<title>09d82d7c91df41558a00225ee61bae8f</title>
<image xlink:href="/icons/action.png" width="101px" height="101px" preserveAspectRatio="xMinYMin meet" x="193.831" y="-119" />
<text text-anchor="middle" x="244.33" y="-3.6" font-family="Sans-Serif" font-size="13.00" fill="#2d3436">Fetch Barcode from TEM_db</text>
</g>
<!-- bd6086867fd742b8a34e3e3c0cc37b78&#45;&gt;09d82d7c91df41558a00225ee61bae8f -->
<g id="edge2" class="edge">
<title>bd6086867fd742b8a34e3e3c0cc37b78-&gt;09d82d7c91df41558a00225ee61bae8f</title>
<path fill="none" stroke="#7b8894" d="M233.18,-173.62C234.09,-165.03 235.03,-156.19 235.95,-147.45" />
<polygon fill="#7b8894" stroke="#7b8894" points="239.46,-147.58 237.03,-137.27 232.5,-146.84 239.46,-147.58" />
</g>
<!-- bd22d406f22e4c1fa50c8947e4136a93 -->
<g id="node4" class="node">
<title>bd22d406f22e4c1fa50c8947e4136a93</title>
<image xlink:href="/icons/action.png" width="101px" height="101px" preserveAspectRatio="xMinYMin meet" x="288.652" y="-424.522" />
<text text-anchor="middle" x="339.15" y="-309.12" font-family="Sans-Serif" font-size="13.00" fill="#2d3436">Initialization &amp; Logging</text>
</g>
<!-- bd6086867fd742b8a34e3e3c0cc37b78&#45;&gt;bd22d406f22e4c1fa50c8947e4136a93 -->
<g id="edge3" class="edge">
<title>bd6086867fd742b8a34e3e3c0cc37b78-&gt;bd22d406f22e4c1fa50c8947e4136a93</title>
<path fill="none" stroke="#7b8894" d="M276.56,-301.24C278.31,-303.28 280.07,-305.32 281.83,-307.37" />
<polygon fill="#7b8894" stroke="#7b8894" points="279.44,-309.96 288.61,-315.26 284.74,-305.39 279.44,-309.96" />
</g>
<!-- cf875cbd4f7e4151897da3fb907a6e5b -->
<g id="node5" class="node">
<title>cf875cbd4f7e4151897da3fb907a6e5b</title>
<image xlink:href="/icons/decision.png" width="101px" height="101px" preserveAspectRatio="xMinYMin meet" x="374.771" y="-579.121" />
<text text-anchor="middle" x="425.27" y="-463.72" font-family="Sans-Serif" font-size="13.00" fill="#2d3436">Check if State is PAUSE</text>
</g>
<!-- bd22d406f22e4c1fa50c8947e4136a93&#45;&gt;cf875cbd4f7e4151897da3fb907a6e5b -->
<g id="edge4" class="edge">
<title>bd22d406f22e4c1fa50c8947e4136a93-&gt;cf875cbd4f7e4151897da3fb907a6e5b</title>
<path fill="none" stroke="#7b8894" d="M377.43,-442.73C378.95,-445.47 380.48,-448.21 382.01,-450.96" />
<polygon fill="#7b8894" stroke="#7b8894" points="378.97,-452.7 386.9,-459.73 385.09,-449.29 378.97,-452.7" />
</g>
<!-- 09d18a59ca23478e8ad1e1c8b47d2998 -->
<g id="node6" class="node">
<title>09d18a59ca23478e8ad1e1c8b47d2998</title>
<image xlink:href="/icons/action.png" width="101px" height="101px" preserveAspectRatio="xMinYMin meet" x="266.668" y="-724.121" />
<text text-anchor="middle" x="317.17" y="-608.72" font-family="Sans-Serif" font-size="13.00" fill="#2d3436">Retry after 0.2s</text>
</g>
<!-- cf875cbd4f7e4151897da3fb907a6e5b&#45;&gt;09d18a59ca23478e8ad1e1c8b47d2998 -->
<g id="edge6" class="edge">
<title>cf875cbd4f7e4151897da3fb907a6e5b-&gt;09d18a59ca23478e8ad1e1c8b47d2998</title>
<path fill="none" stroke="#7b8894" d="M374.71,-571.1C367.99,-579.27 361.21,-588.06 354.75,-596.92" />
<polygon fill="#7b8894" stroke="#7b8894" points="351.89,-594.9 348.92,-605.07 357.59,-598.97 351.89,-594.9" />
</g>
<!-- 2f4f92d174e3460c9401de34086de334 -->
<g id="node7" class="node">
<title>2f4f92d174e3460c9401de34086de334</title>
<image xlink:href="/icons/action.png" width="101px" height="101px" preserveAspectRatio="xMinYMin meet" x="546.066" y="-609.88" />
<text text-anchor="middle" x="596.57" y="-494.48" font-family="Sans-Serif" font-size="13.00" fill="#2d3436">Preparatory Actions</text>
</g>
<!-- cf875cbd4f7e4151897da3fb907a6e5b&#45;&gt;2f4f92d174e3460c9401de34086de334 -->
<g id="edge5" class="edge">
<title>cf875cbd4f7e4151897da3fb907a6e5b-&gt;2f4f92d174e3460c9401de34086de334</title>
<path fill="none" stroke="#7b8894" d="M476.2,-537.77C494.93,-541.13 516.32,-544.97 535.83,-548.47" />
<polygon fill="#7b8894" stroke="#7b8894" points="535.37,-551.95 545.83,-550.27 536.61,-545.06 535.37,-551.95" />
</g>
<!-- 09d18a59ca23478e8ad1e1c8b47d2998&#45;&gt;cf875cbd4f7e4151897da3fb907a6e5b -->
<g id="edge7" class="edge">
<title>09d18a59ca23478e8ad1e1c8b47d2998-&gt;cf875cbd4f7e4151897da3fb907a6e5b</title>
<path fill="none" stroke="#7b8894" d="M367.98,-631.97C374.89,-623.62 381.86,-614.62 388.47,-605.52" />
<polygon fill="#7b8894" stroke="#7b8894" points="391.47,-607.33 394.43,-597.16 385.77,-603.27 391.47,-607.33" />
</g>
<!-- ef1702182a104dc4a44dcdeeea20f58a -->
<g id="node8" class="node">
<title>ef1702182a104dc4a44dcdeeea20f58a</title>
<image xlink:href="/icons/action.png" width="101px" height="101px" preserveAspectRatio="xMinYMin meet" x="704.898" y="-654.011" />
<text text-anchor="middle" x="755.4" y="-538.61" font-family="Sans-Serif" font-size="13.00" fill="#2d3436">Check Abort Conditions</text>
</g>
<!-- 2f4f92d174e3460c9401de34086de334&#45;&gt;ef1702182a104dc4a44dcdeeea20f58a -->
<g id="edge8" class="edge">
<title>2f4f92d174e3460c9401de34086de334-&gt;ef1702182a104dc4a44dcdeeea20f58a</title>
<path fill="none" stroke="#7b8894" d="M647.26,-573.46C662.45,-577.68 679.25,-582.35 695,-586.73" />
<polygon fill="#7b8894" stroke="#7b8894" points="694.07,-590.1 704.64,-589.41 695.95,-583.36 694.07,-590.1" />
</g>
<!-- bd4feead9da44c2f9d7bee0b13816b5b -->
<g id="node9" class="node">
<title>bd4feead9da44c2f9d7bee0b13816b5b</title>
<image xlink:href="/icons/action.png" width="101px" height="101px" preserveAspectRatio="xMinYMin meet" x="858.844" y="-704.767" />
<text text-anchor="middle" x="909.34" y="-589.37" font-family="Sans-Serif" font-size="13.00" fill="#2d3436">Handle Tape &amp; Aperture</text>
</g>
<!-- ef1702182a104dc4a44dcdeeea20f58a&#45;&gt;bd4feead9da44c2f9d7bee0b13816b5b -->
<g id="edge9" class="edge">
<title>ef1702182a104dc4a44dcdeeea20f58a-&gt;bd4feead9da44c2f9d7bee0b13816b5b</title>
<path fill="none" stroke="#7b8894" d="M806.23,-620.27C819.97,-624.8 834.96,-629.74 849.15,-634.42" />
<polygon fill="#7b8894" stroke="#7b8894" points="848.23,-637.8 858.83,-637.61 850.42,-631.16 848.23,-637.8" />
</g>
<!-- e5a1136cba88441fabe5fbc6257907d2 -->
<g id="node10" class="node">
<title>e5a1136cba88441fabe5fbc6257907d2</title>
<image xlink:href="/icons/action.png" width="101px" height="101px" preserveAspectRatio="xMinYMin meet" x="1008.92" y="-763.18" />
<text text-anchor="middle" x="1059.42" y="-647.78" font-family="Sans-Serif" font-size="13.00" fill="#2d3436">Aperture Movement &amp; Correction</text>
</g>
<!-- bd4feead9da44c2f9d7bee0b13816b5b&#45;&gt;e5a1136cba88441fabe5fbc6257907d2 -->
<g id="edge10" class="edge">
<title>bd4feead9da44c2f9d7bee0b13816b5b-&gt;e5a1136cba88441fabe5fbc6257907d2</title>
<path fill="none" stroke="#7b8894" d="M960.15,-674.04C972.81,-678.97 986.5,-684.3 999.55,-689.38" />
<polygon fill="#7b8894" stroke="#7b8894" points="998.33,-692.66 1008.92,-693.02 1000.87,-686.13 998.33,-692.66" />
</g>
<!-- 9320d973725e4e7b87ef6ed920e1d35b -->
<g id="node11" class="node">
<title>9320d973725e4e7b87ef6ed920e1d35b</title>
<image xlink:href="/icons/action.png" width="101px" height="101px" preserveAspectRatio="xMinYMin meet" x="1153.58" y="-832.842" />
<text text-anchor="middle" x="1204.08" y="-717.44" font-family="Sans-Serif" font-size="13.00" fill="#2d3436">Lens &amp; Beam Adjustments</text>
</g>
<!-- e5a1136cba88441fabe5fbc6257907d2&#45;&gt;9320d973725e4e7b87ef6ed920e1d35b -->
<g id="edge11" class="edge">
<title>e5a1136cba88441fabe5fbc6257907d2-&gt;9320d973725e4e7b87ef6ed920e1d35b</title>
<path fill="none" stroke="#7b8894" d="M1110.02,-737.04C1121.07,-742.37 1132.88,-748.05 1144.26,-753.53" />
<polygon fill="#7b8894" stroke="#7b8894" points="1142.74,-756.69 1153.27,-757.87 1145.78,-750.38 1142.74,-756.69" />
</g>
<!-- e78f63d97ceb4e4fbbd19de446b40ea8 -->
<g id="node12" class="node">
<title>e78f63d97ceb4e4fbbd19de446b40ea8</title>
<image xlink:href="/icons/action.png" width="101px" height="101px" preserveAspectRatio="xMinYMin meet" x="1291.15" y="-915.103" />
<text text-anchor="middle" x="1341.65" y="-799.7" font-family="Sans-Serif" font-size="13.00" fill="#2d3436">Brightfield Imaging</text>
</g>
<!-- 9320d973725e4e7b87ef6ed920e1d35b&#45;&gt;e78f63d97ceb4e4fbbd19de446b40ea8 -->
<g id="edge12" class="edge">
<title>9320d973725e4e7b87ef6ed920e1d35b-&gt;e78f63d97ceb4e4fbbd19de446b40ea8</title>
<path fill="none" stroke="#7b8894" d="M1254.92,-812.74C1263.85,-818.08 1273.22,-823.68 1282.35,-829.15" />
<polygon fill="#7b8894" stroke="#7b8894" points="1280.65,-832.2 1291.02,-834.33 1284.24,-826.19 1280.65,-832.2" />
</g>
<!-- e634a3260d154be3ab98a7cb099b253c -->
<g id="node13" class="node">
<title>e634a3260d154be3ab98a7cb099b253c</title>
<image xlink:href="/icons/action.png" width="101px" height="101px" preserveAspectRatio="xMinYMin meet" x="1423.63" y="-1004.99" />
<text text-anchor="middle" x="1474.13" y="-889.59" font-family="Sans-Serif" font-size="13.00" fill="#2d3436">Lens Correction Montage</text>
</g>
<!-- e78f63d97ceb4e4fbbd19de446b40ea8&#45;&gt;e634a3260d154be3ab98a7cb099b253c -->
<g id="edge13" class="edge">
<title>e78f63d97ceb4e4fbbd19de446b40ea8-&gt;e634a3260d154be3ab98a7cb099b253c</title>
<path fill="none" stroke="#7b8894" d="M1392.49,-899.1C1399.73,-904.01 1407.22,-909.1 1414.61,-914.11" />
<polygon fill="#7b8894" stroke="#7b8894" points="1412.96,-917.22 1423.2,-919.94 1416.89,-911.43 1412.96,-917.22" />
</g>
<!-- c72e87fd830944c99c443a0014e14a21 -->
<g id="node14" class="node">
<title>c72e87fd830944c99c443a0014e14a21</title>
<image xlink:href="/icons/action.png" width="101px" height="101px" preserveAspectRatio="xMinYMin meet" x="1546.81" y="-1107.11" />
<text text-anchor="middle" x="1597.31" y="-991.71" font-family="Sans-Serif" font-size="13.00" fill="#2d3436">Finalizing &amp; Error Handling</text>
</g>
<!-- e634a3260d154be3ab98a7cb099b253c&#45;&gt;c72e87fd830944c99c443a0014e14a21 -->
<g id="edge14" class="edge">
<title>e634a3260d154be3ab98a7cb099b253c-&gt;c72e87fd830944c99c443a0014e14a21</title>
<path fill="none" stroke="#7b8894" d="M1524.94,-996.61C1529.53,-1000.41 1534.19,-1004.28 1538.84,-1008.13" />
<polygon fill="#7b8894" stroke="#7b8894" points="1536.68,-1010.89 1546.61,-1014.58 1541.15,-1005.5 1536.68,-1010.89" />
</g>
<!-- 686a3b39b51944d18d0c2fa9bed3065a -->
<g id="node15" class="node">
<title>686a3b39b51944d18d0c2fa9bed3065a</title>
<image xlink:href="/icons/action.png" width="101px" height="101px" preserveAspectRatio="xMinYMin meet" x="1658.81" y="-1221.13" />
<text text-anchor="middle" x="1709.31" y="-1105.73" font-family="Sans-Serif" font-size="13.00" fill="#2d3436">Set State to NONE</text>
</g>
<!-- c72e87fd830944c99c443a0014e14a21&#45;&gt;686a3b39b51944d18d0c2fa9bed3065a -->
<g id="edge15" class="edge">
<title>c72e87fd830944c99c443a0014e14a21-&gt;686a3b39b51944d18d0c2fa9bed3065a</title>
<path fill="none" stroke="#7b8894" d="M1648.07,-1108.28C1649.15,-1109.39 1650.24,-1110.49 1651.33,-1111.6" />
<polygon fill="#7b8894" stroke="#7b8894" points="1649.01,-1114.23 1658.51,-1118.92 1654,-1109.33 1649.01,-1114.23" />
</g>
</g>
</svg></div>

</div>
    </div>
</div>
        <footer class="mdl-mega-footer">
  <div class="mdl-mega-footer__middle-section">
    
  </div>
  <div class="mdl-mega-footer__bottom-section">
    <ul class="mdl-mega-footer__link-list">
      
    </ul>
  </div>
</footer>

      </main>
    </div>
  </body>
</html>
